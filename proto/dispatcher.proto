syntax = "proto3";

// No package declaration - matches upstream Hatchet proto.
// gRPC service path is /Dispatcher/Method (not /hatchet.dispatcher.Dispatcher/Method)

// The Hatchet dispatcher service for worker communication
service Dispatcher {
  // Register a worker with the dispatcher
  rpc Register(WorkerRegisterRequest) returns (WorkerRegisterResponse);

  // Server stream for task assignments
  rpc ListenV2(WorkerListenRequest) returns (stream AssignedAction);

  // Send step action events (part of bidirectional stream)
  rpc SendStepActionEvent(StepActionEvent) returns (ActionEventResponse);

  // Send heartbeat to keep connection alive
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
}

// ============================================================================
// Worker Registration
// ============================================================================

message WorkerRegisterRequest {
  string workerName = 1;
  repeated string actions = 2;
  repeated string services = 3;
  optional int32 maxRuns = 4;
  map<string, WorkerLabels> labels = 5;
  optional string webhookId = 6;
  RuntimeInfo runtimeInfo = 7;
}

message WorkerLabels {
  optional string strValue = 1;
  optional int32 intValue = 2;
}

message RuntimeInfo {
  optional string sdkVersion = 1;
  optional SDKS language = 2;
  optional string languageVersion = 3;
  optional string os = 4;
  optional string extra = 5;
}

enum SDKS {
  UNKNOWN = 0;
  GO = 1;
  PYTHON = 2;
  TYPESCRIPT = 3;
}

message WorkerRegisterResponse {
  string tenantId = 1;
  string workerId = 2;
  string workerName = 3;
}

// ============================================================================
// Worker Listen
// ============================================================================

message WorkerListenRequest {
  string workerId = 1;
}

// ============================================================================
// Assigned Action
// ============================================================================

message AssignedAction {
  string tenantId = 1;
  string workflowRunId = 2;
  string getGroupKeyRunId = 3;
  string jobId = 4;
  string jobName = 5;
  string jobRunId = 6;
  string stepId = 7;
  string stepRunId = 8;
  string actionId = 9;
  ActionType actionType = 10;
  string actionPayload = 11;
  string stepName = 12;
  int32 retryCount = 13;
  optional string additionalMetadata = 14;
  optional int32 childWorkflowIndex = 15;
  optional string childWorkflowKey = 16;
  optional string parentWorkflowRunId = 17;
  int32 priority = 18;
  optional string workflowId = 19;
  optional string workflowVersionId = 20;
}

enum ActionType {
  START_STEP_RUN = 0;
  CANCEL_STEP_RUN = 1;
  START_GET_GROUP_KEY = 2;
}

// ============================================================================
// Step Action Event
// ============================================================================

message StepActionEvent {
  string workerId = 1;
  string jobId = 2;
  string jobRunId = 3;
  string stepId = 4;
  string stepRunId = 5;
  string actionId = 6;
  int64 eventTimestamp = 7;
  StepActionEventType eventType = 8;
  string eventPayload = 9;
  optional int32 retryCount = 10;
  optional bool shouldNotRetry = 11;
}

enum StepActionEventType {
  STEP_EVENT_TYPE_UNKNOWN = 0;
  STEP_EVENT_TYPE_STARTED = 1;
  STEP_EVENT_TYPE_COMPLETED = 2;
  STEP_EVENT_TYPE_FAILED = 3;
  STEP_EVENT_TYPE_ACKNOWLEDGED = 4;
}

message ActionEventResponse {
  string tenantId = 1;
  string workerId = 2;
}

// ============================================================================
// Heartbeat
// ============================================================================

message HeartbeatRequest {
  string workerId = 1;
  int64 heartbeatAt = 2;
}

message HeartbeatResponse {
}
