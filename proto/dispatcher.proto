syntax = "proto3";

// No package declaration - matches upstream Hatchet proto.
// gRPC service path is /Dispatcher/Method (not /hatchet.dispatcher.Dispatcher/Method)

// The Hatchet dispatcher service for worker communication
service Dispatcher {
  // Register a worker with the dispatcher
  rpc Register(WorkerRegisterRequest) returns (WorkerRegisterResponse);

  // Bidirectional stream for task assignments
  rpc ListenV2(stream WorkerListenRequest) returns (stream AssignedAction);

  // Send step action events (part of bidirectional stream)
  rpc SendStepActionEvent(StepActionEvent) returns (ActionEventResponse);

  // Send heartbeat to keep connection alive
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
}

// ============================================================================
// Worker Registration
// ============================================================================

message WorkerRegisterRequest {
  string worker_name = 1;
  repeated string actions = 2;
  repeated string services = 3;
  optional int32 max_runs = 4;
  map<string, WorkerLabels> labels = 5;
  optional string webhook_id = 6;
  RuntimeInfo runtime_info = 7;
}

message WorkerLabels {
  optional string str_value = 1;
  optional int32 int_value = 2;
}

message RuntimeInfo {
  optional string sdk_version = 1;
  optional SDKS language = 2;
  optional string language_version = 3;
  optional string os = 4;
  optional string extra = 5;
}

enum SDKS {
  UNKNOWN = 0;
  GO = 1;
  PYTHON = 2;
  TYPESCRIPT = 3;
  GLEAM = 4;  // Added for Gleam SDK
}

message WorkerRegisterResponse {
  string tenant_id = 1;
  string worker_id = 2;
  string worker_name = 3;
}

// ============================================================================
// Worker Listen
// ============================================================================

message WorkerListenRequest {
  string worker_id = 1;
}

// ============================================================================
// Assigned Action
// ============================================================================

message AssignedAction {
  string tenant_id = 1;
  string workflow_run_id = 2;
  string get_group_key_run_id = 3;
  string job_id = 4;
  string job_name = 5;
  string job_run_id = 6;
  string step_id = 7;
  string step_run_id = 8;
  string action_id = 9;
  ActionType action_type = 10;
  string action_payload = 11;
  string step_name = 12;
  int32 retry_count = 13;
  optional string additional_metadata = 14;
  optional int32 child_workflow_index = 15;
  optional string child_workflow_key = 16;
  optional string parent_workflow_run_id = 17;
  int32 priority = 18;
  optional string workflow_id = 19;
  optional string workflow_version_id = 20;
}

enum ActionType {
  START_STEP_RUN = 0;
  CANCEL_STEP_RUN = 1;
  START_GET_GROUP_KEY = 2;
}

// ============================================================================
// Step Action Event
// ============================================================================

message StepActionEvent {
  string worker_id = 1;
  string job_id = 2;
  string job_run_id = 3;
  string step_id = 4;
  string step_run_id = 5;
  string action_id = 6;
  int64 event_timestamp = 7;
  StepActionEventType event_type = 8;
  string event_payload = 9;
  optional int32 retry_count = 10;
  optional bool should_not_retry = 11;
}

enum StepActionEventType {
  STEP_EVENT_TYPE_UNKNOWN = 0;
  STEP_EVENT_TYPE_STARTED = 1;
  STEP_EVENT_TYPE_COMPLETED = 2;
  STEP_EVENT_TYPE_FAILED = 3;
  STEP_EVENT_TYPE_ACKNOWLEDGED = 4;
}

message ActionEventResponse {
  string tenant_id = 1;
  string worker_id = 2;
}

// ============================================================================
// Heartbeat
// ============================================================================

message HeartbeatRequest {
  string worker_id = 1;
  int64 heartbeat_at = 2;
}

message HeartbeatResponse {
}
